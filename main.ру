import os
import logging
import time
import threading
from datetime import datetime
from flask import Flask, request
import telebot
from pybit.unified_trading import HTTP

# ========== –ù–ê–°–¢–†–û–ô–ö–ê ==========

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# –¢–æ–∫–µ–Ω—ã –∏ –∫–ª—é—á–∏ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
TELEGRAM_TOKEN = os.environ.get('TELEGRAM_TOKEN')
BYBIT_API_KEY = os.environ.get('BYBIT_API_KEY')
BYBIT_API_SECRET = os.environ.get('BYBIT_API_SECRET')

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–æ—Ä–≥–æ–≤–ª–∏
SYMBOL = "BTCUSDT"
AMOUNT = 10  # 10 USDT
TARGET_PROFIT_PERCENT = 0.5  # +0.5%
MARKET_UNIT = "quoteCoin"

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–≤—Ç–æ—Ç–æ—Ä–≥–æ–≤–ª–∏
AUTO_TRADE_ENABLED = True
CHECK_INTERVAL = 300  # 5 –º–∏–Ω—É—Ç
RSI_OVERSOLD = 30  # RSI –¥–ª—è –ø–æ–∫—É–ø–∫–∏

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
bot = telebot.TeleBot(TELEGRAM_TOKEN)
app = Flask(__name__)

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Bybit
session = HTTP(
    testnet=False,
    api_key=BYBIT_API_KEY,
    api_secret=BYBIT_API_SECRET
)

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫
active_trades = {}

# ID —á–∞—Ç–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ç–≤–æ–π)
ADMIN_CHAT_ID = os.environ.get('ADMIN_CHAT_ID')

# ========== –§–£–ù–ö–¶–ò–ò BYBIT ==========

def get_balance():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ USDT"""
    try:
        response = session.get_wallet_balance(
            accountType="UNIFIED",
            coin="USDT"
        )
        if response['retCode'] == 0:
            balance = response['result']['list'][0]['coin'][0]['walletBalance']
            return float(balance)
        logger.error(f"–û—à–∏–±–∫–∞ –±–∞–ª–∞–Ω—Å–∞: {response}")
        return 0
    except Exception as e:
        logger.error(f"–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞: {e}")
        return 0

def get_current_price():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã"""
    try:
        response = session.get_tickers(category="spot", symbol=SYMBOL)
        if response['retCode'] == 0:
            return float(response['result']['list'][0]['lastPrice'])
        logger.error(f"–û—à–∏–±–∫–∞ —Ü–µ–Ω—ã: {response}")
        return 0
    except Exception as e:
        logger.error(f"–ò—Å–∫–ª—é—á–µ–Ω–∏–µ —Ü–µ–Ω—ã: {e}")
        return 0

def get_historical_prices(limit=50):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω –¥–ª—è RSI"""
    try:
        response = session.get_kline(
            category="spot",
            symbol=SYMBOL,
            interval="15",
            limit=limit
        )
        if response['retCode'] == 0:
            # –¶–µ–Ω—ã –∑–∞–∫—Ä—ã—Ç–∏—è
            return [float(item[4]) for item in response['result']['list']]
        return []
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏: {e}")
        return []

def calculate_rsi(prices, period=14):
    """–†–∞—Å—á–µ—Ç RSI"""
    if len(prices) < period + 1:
        return 50
    
    gains = []
    losses = []
    
    for i in range(1, len(prices)):
        diff = prices[i] - prices[i-1]
        if diff >= 0:
            gains.append(diff)
            losses.append(0)
        else:
            gains.append(0)
            losses.append(abs(diff))
    
    avg_gain = sum(gains[-period:]) / period
    avg_loss = sum(losses[-period:]) / period
    
    if avg_loss == 0:
        return 100
    
    rs = avg_gain / avg_loss
    rsi = 100 - (100 / (1 + rs))
    return rsi

def place_buy_order():
    """–†–∞–∑–º–µ—â–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–∞ –Ω–∞ –ø–æ–∫—É–ø–∫—É"""
    try:
        params = {
            "category": "spot",
            "symbol": SYMBOL,
            "side": "Buy",
            "orderType": "Market",
            "qty": str(AMOUNT),
            "marketUnit": MARKET_UNIT
        }
        
        logger.info(f"–ü–æ–∫—É–ø–∫–∞: {params}")
        response = session.place_order(**params)
        
        if response['retCode'] == 0:
            return {
                "success": True,
                "order_id": response['result']['orderId']
            }
        else:
            return {
                "success": False,
                "error": response['retMsg']
            }
    except Exception as e:
        return {
            "success": False,
            "error": str(e)
        }

def place_sell_order(qty):
    """–†–∞–∑–º–µ—â–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∂—É"""
    try:
        params = {
            "category": "spot",
            "symbol": SYMBOL,
            "side": "Sell",
            "orderType": "Market",
            "qty": str(qty),
            "marketUnit": "baseCoin"
        }
        
        logger.info(f"–ü—Ä–æ–¥–∞–∂–∞: {params}")
        response = session.place_order(**params)
        
        if response['retCode'] == 0:
            return {
                "success": True,
                "order_id": response['result']['orderId']
            }
        else:
            return {
                "success": False,
                "error": response['retMsg']
            }
    except Exception as e:
        return {
            "success": False,
            "error": str(e)
        }

# ========== –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –¢–û–†–ì–û–í–õ–Ø ==========

def auto_trader():
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç—Ä–µ–π–¥–µ—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ RSI"""
    global AUTO_TRADE_ENABLED
    
    logger.info("üöÄ –ê–≤—Ç–æ—Ç—Ä–µ–π–¥–µ—Ä –∑–∞–ø—É—â–µ–Ω")
    
    while AUTO_TRADE_ENABLED:
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏
            if len(active_trades) > 0:
                time.sleep(CHECK_INTERVAL)
                continue
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
            balance = get_balance()
            if balance < AMOUNT:
                logger.warning(f"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤: {balance:.2f} USDT")
                time.sleep(CHECK_INTERVAL * 6)
                continue
            
            # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—ã –∏ RSI
            prices = get_historical_prices()
            if len(prices) < 20:
                time.sleep(60)
                continue
            
            rsi = calculate_rsi(prices)
            current_price = prices[-1]
            
            logger.info(f"RSI: {rsi:.2f}, –¶–µ–Ω–∞: ${current_price:.2f}")
            
            # –°–∏–≥–Ω–∞–ª –Ω–∞ –ø–æ–∫—É–ø–∫—É
            if rsi < RSI_OVERSOLD:
                logger.info(f"üî• –°–ò–ì–ù–ê–õ! RSI {rsi:.2f} < {RSI_OVERSOLD}")
                
                # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
                if ADMIN_CHAT_ID:
                    bot.send_message(
                        ADMIN_CHAT_ID,
                        f"üìä –°–∏–≥–Ω–∞–ª –Ω–∞ –ø–æ–∫—É–ø–∫—É!\nRSI: {rsi:.2f}\n–ü–æ–∫—É–ø–∞—é BTC..."
                    )
                
                # –ü–æ–∫—É–ø–∞–µ–º
                result = place_buy_order()
                
                if result["success"]:
                    price = get_current_price()
                    btc_amount = AMOUNT / price
                    target_price = price * (1 + TARGET_PROFIT_PERCENT / 100)
                    
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–¥–µ–ª–∫—É
                    chat_id = ADMIN_CHAT_ID or 0
                    active_trades[chat_id] = {
                        "buy_price": price,
                        "btc_amount": btc_amount,
                        "target_price": target_price,
                        "order_id": result["order_id"],
                        "rsi": rsi
                    }
                    
                    logger.info(f"‚úÖ –ö—É–ø–ª–µ–Ω–æ {btc_amount:.6f} BTC –ø–æ ${price:.2f}")
                    
                    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    if ADMIN_CHAT_ID:
                        bot.send_message(
                            ADMIN_CHAT_ID,
                            f"‚úÖ –ê–í–¢–û–ü–û–ö–£–ü–ö–ê!\n\n"
                            f"–ö—É–ø–ª–µ–Ω–æ: {btc_amount:.6f} BTC\n"
                            f"–¶–µ–Ω–∞: ${price:,.2f}\n"
                            f"RSI: {rsi:.2f}\n"
                            f"–¶–µ–ª—å: ${target_price:,.2f}"
                        )
                    
                    # –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
                    monitor_price(chat_id, btc_amount, target_price)
                    
                else:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏: {result['error']}")
                    if ADMIN_CHAT_ID:
                        bot.send_message(
                            ADMIN_CHAT_ID,
                            f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏: {result['error']}"
                        )
            
            # –ñ–¥–µ–º
            time.sleep(CHECK_INTERVAL)
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ç—Ä–µ–π–¥–µ—Ä–∞: {e}")
            time.sleep(60)

def monitor_price(chat_id, btc_amount, target_price):
    """–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ü–µ–Ω—ã –∏ –ø—Ä–æ–¥–∞–∂–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ü–µ–ª–∏"""
    
    def check():
        while chat_id in active_trades:
            try:
                current_price = get_current_price()
                
                if current_price >= target_price:
                    logger.info(f"–¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞! {current_price} >= {target_price}")
                    
                    # –ü—Ä–æ–¥–∞–µ–º
                    result = place_sell_order(btc_amount)
                    
                    if result["success"]:
                        buy_price = active_trades[chat_id]["buy_price"]
                        profit = (current_price - buy_price) * btc_amount
                        
                        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                        if chat_id != 0:
                            bot.send_message(
                                chat_id,
                                f"üéØ –¶–ï–õ–¨ –î–û–°–¢–ò–ì–ù–£–¢–ê!\n\n"
                                f"–ü—Ä–æ–¥–∞–Ω–æ: {btc_amount:.6f} BTC\n"
                                f"–¶–µ–Ω–∞: ${current_price:,.2f}\n"
                                f"–ü—Ä–∏–±—ã–ª—å: ${profit:.2f} USDT"
                            )
                        
                        logger.info(f"‚úÖ –ü—Ä–æ–¥–∞–Ω–æ, –ø—Ä–∏–±—ã–ª—å ${profit:.2f}")
                        del active_trades[chat_id]
                        
                    else:
                        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–¥–∞–∂–∏: {result['error']}")
                        if chat_id != 0:
                            bot.send_message(
                                chat_id,
                                f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–¥–∞–∂–∏: {result['error']}"
                            )
                    
                    break
                
                time.sleep(10)  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
                
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: {e}")
                time.sleep(30)
    
    thread = threading.Thread(target=check)
    thread.daemon = True
    thread.start()

# ========== –ö–û–ú–ê–ù–î–´ –¢–ï–õ–ï–ì–†–ê–ú ==========

@bot.message_handler(commands=['start'])
def start_command(message):
    """–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ"""
    text = (
        "ü§ñ –ë–æ—Ç –¥–ª—è –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ô —Ç–æ—Ä–≥–æ–≤–ª–∏ –Ω–∞ Bybit\n\n"
        "–†–µ–∂–∏–º: –ü–û–õ–ù–´–ô –ê–í–¢–û–ú–ê–¢ (–ø—Ä–æ–≤–µ—Ä–∫–∞ RSI –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/buy - –†—É—á–Ω–∞—è –ø–æ–∫—É–ø–∫–∞\n"
        "/status - –°—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏\n"
        "/balance - –ë–∞–ª–∞–Ω—Å\n"
        "/price - –¶–µ–Ω–∞ BTC\n"
        "/rsi - –¢–µ–∫—É—â–∏–π RSI\n"
        "/autoon - –í–∫–ª –∞–≤—Ç–æ\n"
        "/autooff - –í—ã–∫–ª –∞–≤—Ç–æ"
    )
    bot.reply_to(message, text)

@bot.message_handler(commands=['price'])
def price_command(message):
    """–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞"""
    price = get_current_price()
    if price:
        bot.reply_to(message, f"üìä BTC: ${price:,.2f}")
    else:
        bot.reply_to(message, "‚ùå –û—à–∏–±–∫–∞")

@bot.message_handler(commands=['balance'])
def balance_command(message):
    """–ë–∞–ª–∞–Ω—Å"""
    balance = get_balance()
    price = get_current_price()
    if price:
        btc = balance / price
        bot.reply_to(message, f"üí∞ USDT: {balance:.2f}\nBTC: {btc:.6f}")
    else:
        bot.reply_to(message, f"üí∞ USDT: {balance:.2f}")

@bot.message_handler(commands=['rsi'])
def rsi_command(message):
    """–¢–µ–∫—É—â–∏–π RSI"""
    prices = get_historical_prices()
    if len(prices) > 14:
        rsi = calculate_rsi(prices)
        status = "üìâ –ü–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å" if rsi < 30 else "üìà –ü–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å" if rsi > 70 else "‚û°Ô∏è –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ"
        bot.reply_to(message, f"üìä RSI: {rsi:.2f}\n{status}")
    else:
        bot.reply_to(message, "‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö")

@bot.message_handler(commands=['status'])
def status_command(message):
    """–°—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏"""
    chat_id = message.chat.id
    
    if chat_id in active_trades:
        t = active_trades[chat_id]
        price = get_current_price()
        profit = ((price - t['buy_price']) / t['buy_price']) * 100
        
        bot.reply_to(message,
            f"üìà –ê–ö–¢–ò–í–ù–ê–Ø –°–î–ï–õ–ö–ê\n\n"
            f"–ö—É–ø–ª–µ–Ω–æ: {t['btc_amount']:.6f} BTC\n"
            f"–¶–µ–Ω–∞: ${t['buy_price']:,.2f}\n"
            f"–°–µ–π—á–∞—Å: ${price:,.2f}\n"
            f"–ü—Ä–∏–±—ã–ª—å: {profit:+.2f}%\n"
            f"–¶–µ–ª—å: ${t['target_price']:,.2f}")
    else:
        bot.reply_to(message, "üì≠ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫")

@bot.message_handler(commands=['buy'])
def buy_command(message):
    """–†—É—á–Ω–∞—è –ø–æ–∫—É–ø–∫–∞"""
    chat_id = message.chat.id
    
    if chat_id in active_trades:
        bot.reply_to(message, "‚ö†Ô∏è –£–∂–µ –µ—Å—Ç—å —Å–¥–µ–ª–∫–∞")
        return
    
    balance = get_balance()
    if balance < AMOUNT:
        bot.reply_to(message, f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ: {balance:.2f} USDT")
        return
    
    bot.reply_to(message, "üîÑ –ü–æ–∫—É–ø–∞—é...")
    
    result = place_buy_order()
    
    if result["success"]:
        price = get_current_price()
        btc = AMOUNT / price
        target = price * 1.005
        
        active_trades[chat_id] = {
            "buy_price": price,
            "btc_amount": btc,
            "target_price": target,
            "order_id": result["order_id"]
        }
        
        bot.reply_to(message,
            f"‚úÖ –ö—É–ø–ª–µ–Ω–æ!\n"
            f"{btc:.6f} BTC –ø–æ ${price:,.2f}\n"
            f"–¶–µ–ª—å: ${target:,.2f}")
        
        monitor_price(chat_id, btc, target)
    else:
        bot.reply_to(message, f"‚ùå –û—à–∏–±–∫–∞: {result['error']}")

@bot.message_handler(commands=['autoon'])
def autoon_command(message):
    """–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ"""
    global AUTO_TRADE_ENABLED
    AUTO_TRADE_ENABLED = True
    bot.reply_to(message, "‚úÖ –ê–≤—Ç–æ—Ç–æ—Ä–≥–æ–≤–ª—è –í–ö–õ")

@bot.message_handler(commands=['autooff'])
def autooff_command(message):
    """–í—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ"""
    global AUTO_TRADE_ENABLED
    AUTO_TRADE_ENABLED = False
    bot.reply_to(message, "‚è∏Ô∏è –ê–≤—Ç–æ—Ç–æ—Ä–≥–æ–≤–ª—è –í–´–ö–õ")

# ========== –í–ï–ë–•–£–ö ==========

@app.route('/webhook', methods=['POST'])
def webhook():
    """–ü—Ä–∏–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram"""
    update = request.get_data(as_text=True)
    try:
        bot.process_new_updates([telebot.types.Update.de_json(update)])
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤–µ–±—Ö—É–∫–∞: {e}")
    return 'OK', 200

@app.route('/')
def index():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã"""
    return "ü§ñ Bybit Auto Trading Bot is running!"

# ========== –ó–ê–ü–£–°–ö ==========

if __name__ == '__main__':
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ—Ç—Ä–µ–π–¥–µ—Ä –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    if AUTO_TRADE_ENABLED:
        trader_thread = threading.Thread(target=auto_trader)
        trader_thread.daemon = True
        trader_thread.start()
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º Flask
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port)
